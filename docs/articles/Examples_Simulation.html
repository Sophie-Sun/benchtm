<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Example for Simulation • benchtm</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />
<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script>

<!-- sticky kit -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



<meta property="og:title" content="Example for Simulation" />

<meta property="og:description" content="" />

<meta property="og:image" content="/logo.png" />
<meta name="twitter:card" content="summary" />



<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-article">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">benchtm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/Examples_Real_Data.html">Example for Real Data</a>
    </li>
    <li>
      <a href="../articles/Examples_Simulation.html">Example for Simulation</a>
    </li>
    <li>
      <a href="../articles/User_guidance.html">User guide</a>
    </li>
    <li>
      <a href="../articles/a01_User_guidance.html">User guide</a>
    </li>
    <li>
      <a href="../articles/a02_Examples_Real_Data.html">Example for Real Data</a>
    </li>
    <li>
      <a href="../articles/a03_Examples_Simulation.html">Example for Simulation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>


<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Example for Simulation</h1>
            
      
      
      <div class="hidden name"><code>Examples_Simulation.Rmd</code></div>

    </div>

    
    
<div id="simulation-example-using-benchtm" class="section level2">
<h2>Simulation example using “benchtm”</h2>
<p>In this section a simple simulation study is performed on subgroup identification using ``benchtm’’ package. We first generate the simuation data with <span class="math inline">\(f_{prog}(X) = 0.5*(X_3+X_7)\)</span> and <span class="math inline">\(f_{pred}(X) = X_3\)</span> with <span class="math inline">\(\beta_0 =0, \beta_1=2\)</span>. We fixed the total number of covariates as <span class="math inline">\(p=20\)</span> and vary the sample size from <span class="math inline">\(n = 200\)</span> to <span class="math inline">\(n=500,1000\)</span>. The simulation is replicated for 100 times in each scenario.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(benchtm)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">set.seed</span>(<span class="dv">1111</span>)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">get_data =<span class="st"> </span><span class="cf">function</span>(n,p,nsim){</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  dat &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, nsim) </a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb1-9" data-line-number="9">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nsim){</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    X &lt;-<span class="st"> </span><span class="kw">generate_X_dist</span>(n, p, <span class="dt">rho=</span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    trt &lt;-<span class="st"> </span><span class="kw">generate_trt</span>(n, <span class="dt">p_trt =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    temp_dat &lt;-<span class="st"> </span><span class="kw">generate_y</span>(X, trt, <span class="dt">prog =</span> <span class="st">&quot;0.5*(X3+X7)&quot;</span>,</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">                   <span class="dt">pred =</span> <span class="st">&quot;X3&quot;</span>, <span class="dt">b0 =</span> <span class="dv">0</span>, <span class="dt">b1 =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">                   <span class="dt">type =</span> <span class="st">&quot;continuous&quot;</span>, <span class="dt">include_truth =</span> <span class="ot">TRUE</span>,<span class="dt">sigma_error =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">   </a>
<a class="sourceLine" id="cb1-16" data-line-number="16">    dat[[i]] =<span class="st"> </span>temp_dat</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">  }</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">  </a>
<a class="sourceLine" id="cb1-19" data-line-number="19">  <span class="kw">return</span>(dat)</a>
<a class="sourceLine" id="cb1-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb1-21" data-line-number="21"></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">dat1 =<span class="st"> </span><span class="kw">get_data</span>(<span class="dt">n=</span><span class="dv">200</span>,<span class="dt">p=</span><span class="dv">20</span>,<span class="dt">nsim=</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">dat2 =<span class="st"> </span><span class="kw">get_data</span>(<span class="dt">n=</span><span class="dv">500</span>,<span class="dt">p=</span><span class="dv">20</span>,<span class="dt">nsim=</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb1-24" data-line-number="24">dat3 =<span class="st"> </span><span class="kw">get_data</span>(<span class="dt">n=</span><span class="dv">1000</span>,<span class="dt">p=</span><span class="dv">20</span>,<span class="dt">nsim=</span><span class="dv">100</span>)</a></code></pre></div>
<p>For demonstration, we only compare two different methods: multivariate and MOBl. Users could modify this part of the code by implementing their own method for a comparison.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">library</span>(glmnet)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">var_select_lasso &lt;-<span class="st"> </span><span class="cf">function</span>(X, Y, trt, event, family){</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  ind &lt;-<span class="st"> </span>trt <span class="op">==</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  X0 &lt;-<span class="st"> </span>X[ind,]</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  X1 &lt;-<span class="st"> </span>X[<span class="op">!</span>ind,]</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  Y0 &lt;-<span class="st"> </span>Y[ind]</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  Y1 &lt;-<span class="st"> </span>Y[<span class="op">!</span>ind]</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  X0 &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span>., <span class="dt">data=</span>X0)[,<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  X1 &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span>., <span class="dt">data=</span>X1)[,<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">  <span class="cf">if</span>(family <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;binomial&quot;</span>, <span class="st">&quot;gaussian&quot;</span>)){</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">    fit0 &lt;-<span class="st"> </span><span class="kw">cv.glmnet</span>(X0, Y0, <span class="dt">family =</span> family)</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">    fit1 &lt;-<span class="st"> </span><span class="kw">cv.glmnet</span>(X1, Y1, <span class="dt">family =</span> family)</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">  }</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">  <span class="cf">if</span>(family <span class="op">==</span><span class="st"> &quot;cox&quot;</span>){</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">    event0 &lt;-<span class="st"> </span>event[ind]</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">    event1 &lt;-<span class="st"> </span>event[<span class="op">!</span>ind]</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">    fit0 &lt;-<span class="st"> </span><span class="kw">cv.glmnet</span>(X0, <span class="kw">Surv</span>(Y0, event0), <span class="dt">family =</span> <span class="st">&quot;cox&quot;</span>)</a>
<a class="sourceLine" id="cb2-21" data-line-number="21">    fit1 &lt;-<span class="st"> </span><span class="kw">cv.glmnet</span>(X1, <span class="kw">Surv</span>(Y1, event1), <span class="dt">family =</span> <span class="st">&quot;cox&quot;</span>)</a>
<a class="sourceLine" id="cb2-22" data-line-number="22">  }</a>
<a class="sourceLine" id="cb2-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb2-24" data-line-number="24">  get_fit_vars &lt;-<span class="st"> </span><span class="cf">function</span>(fit){</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">    cf &lt;-<span class="st"> </span><span class="kw">coef</span>(fit, <span class="dt">s=</span><span class="st">&quot;lambda.1se&quot;</span>)</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">    ## selected variables</a>
<a class="sourceLine" id="cb2-27" data-line-number="27">    vars &lt;-<span class="st"> </span><span class="kw">rownames</span>(cf)[<span class="kw">abs</span>(<span class="kw">as.numeric</span>(cf))<span class="op">&gt;</span><span class="dv">0</span>]</a>
<a class="sourceLine" id="cb2-28" data-line-number="28">    ## recover original variable names</a>
<a class="sourceLine" id="cb2-29" data-line-number="29">    <span class="kw">get_varnames</span>(vars)</a>
<a class="sourceLine" id="cb2-30" data-line-number="30">  }</a>
<a class="sourceLine" id="cb2-31" data-line-number="31">  <span class="kw">union</span>(<span class="kw">get_fit_vars</span>(fit0), <span class="kw">get_fit_vars</span>(fit1))</a>
<a class="sourceLine" id="cb2-32" data-line-number="32">}</a>
<a class="sourceLine" id="cb2-33" data-line-number="33">get_varnames &lt;-<span class="st"> </span><span class="cf">function</span>(vars){</a>
<a class="sourceLine" id="cb2-34" data-line-number="34">  ## recovers original variable names from dummy coding and returns</a>
<a class="sourceLine" id="cb2-35" data-line-number="35">  ## them ordered</a>
<a class="sourceLine" id="cb2-36" data-line-number="36">  vars &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">30</span>), <span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb2-37" data-line-number="37">    vr &lt;-<span class="st"> </span><span class="kw">any</span>(<span class="kw">startsWith</span>(vars, x))</a>
<a class="sourceLine" id="cb2-38" data-line-number="38">    <span class="cf">if</span>(vr)</a>
<a class="sourceLine" id="cb2-39" data-line-number="39">      <span class="kw">return</span>(x)</a>
<a class="sourceLine" id="cb2-40" data-line-number="40">  })</a>
<a class="sourceLine" id="cb2-41" data-line-number="41">  <span class="kw">as.character</span>(<span class="kw">do.call</span>(<span class="st">&quot;c&quot;</span>, vars))</a>
<a class="sourceLine" id="cb2-42" data-line-number="42">}</a>
<a class="sourceLine" id="cb2-43" data-line-number="43"></a>
<a class="sourceLine" id="cb2-44" data-line-number="44">get_var_back &lt;-<span class="st"> </span><span class="cf">function</span>(str){</a>
<a class="sourceLine" id="cb2-45" data-line-number="45">  ## recovers original variable names from dummy coding and returns in</a>
<a class="sourceLine" id="cb2-46" data-line-number="46">  ## original order</a>
<a class="sourceLine" id="cb2-47" data-line-number="47">  str &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;X1[A-Za-z]&quot;</span>, <span class="st">&quot;X1&quot;</span>, str)</a>
<a class="sourceLine" id="cb2-48" data-line-number="48">  str &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;X2[A-Za-z]&quot;</span>, <span class="st">&quot;X2&quot;</span>, str)</a>
<a class="sourceLine" id="cb2-49" data-line-number="49">  str &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;X3[A-Za-z]&quot;</span>, <span class="st">&quot;X3&quot;</span>, str)</a>
<a class="sourceLine" id="cb2-50" data-line-number="50">  str &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;X4[A-Za-z]&quot;</span>, <span class="st">&quot;X4&quot;</span>, str)</a>
<a class="sourceLine" id="cb2-51" data-line-number="51">  str &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;X5[A-Za-z]&quot;</span>, <span class="st">&quot;X5&quot;</span>, str)</a>
<a class="sourceLine" id="cb2-52" data-line-number="52">  str &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;X6[A-Za-z]&quot;</span>, <span class="st">&quot;X6&quot;</span>, str)</a>
<a class="sourceLine" id="cb2-53" data-line-number="53">  str &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;X7[A-Za-z]&quot;</span>, <span class="st">&quot;X7&quot;</span>, str)</a>
<a class="sourceLine" id="cb2-54" data-line-number="54">  str &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;X8[A-Za-z]&quot;</span>, <span class="st">&quot;X8&quot;</span>, str)</a>
<a class="sourceLine" id="cb2-55" data-line-number="55">  str &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;X9[A-Za-z]&quot;</span>, <span class="st">&quot;X9&quot;</span>, str)</a>
<a class="sourceLine" id="cb2-56" data-line-number="56">}</a>
<a class="sourceLine" id="cb2-57" data-line-number="57"></a>
<a class="sourceLine" id="cb2-58" data-line-number="58">multivariate &lt;-<span class="st"> </span><span class="cf">function</span>(X, Y, trt, event, family){</a>
<a class="sourceLine" id="cb2-59" data-line-number="59">  ## select union of variables that impact outcome on treatment and</a>
<a class="sourceLine" id="cb2-60" data-line-number="60">  ## control (this will be a superset of the purely prognostic variables)</a>
<a class="sourceLine" id="cb2-61" data-line-number="61">  ##vars &lt;- var_select_lasso(X, Y, trt, event, family)</a>
<a class="sourceLine" id="cb2-62" data-line-number="62">  fitdat &lt;-<span class="st"> </span><span class="kw">cbind</span>(Y, trt, X)</a>
<a class="sourceLine" id="cb2-63" data-line-number="63">  </a>
<a class="sourceLine" id="cb2-64" data-line-number="64">  all_vars &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">colnames</span>(X), <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>)</a>
<a class="sourceLine" id="cb2-65" data-line-number="65">  <span class="co">#if(length(vars) == 0){ ## if no covariate identified</span></a>
<a class="sourceLine" id="cb2-66" data-line-number="66">  <span class="co">#  form1 &lt;- paste0(&quot;Y~trt+ trt:(&quot;, all_vars ,&quot;)&quot;)</span></a>
<a class="sourceLine" id="cb2-67" data-line-number="67">  <span class="co">#  form2 &lt;- paste0(&quot;Y~trt&quot;)</span></a>
<a class="sourceLine" id="cb2-68" data-line-number="68">  <span class="co">#}else{</span></a>
<a class="sourceLine" id="cb2-69" data-line-number="69">  <span class="co">#vars_form &lt;- paste0(vars, collapse = &quot;+&quot;)</span></a>
<a class="sourceLine" id="cb2-70" data-line-number="70">  form1 &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y~trt+&quot;</span>, all_vars, <span class="st">&quot;+ trt:(&quot;</span>, all_vars,<span class="st">&quot;)&quot;</span>)</a>
<a class="sourceLine" id="cb2-71" data-line-number="71">  form2 &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y~trt+&quot;</span>, all_vars)</a>
<a class="sourceLine" id="cb2-72" data-line-number="72">  <span class="co">#}</span></a>
<a class="sourceLine" id="cb2-73" data-line-number="73">  ## fit linear models and perform global interaction test</a>
<a class="sourceLine" id="cb2-74" data-line-number="74">  <span class="cf">if</span>(family <span class="op">==</span><span class="st"> &quot;gaussian&quot;</span>){</a>
<a class="sourceLine" id="cb2-75" data-line-number="75">    fit1 &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="kw">as.formula</span>(form1), <span class="dt">data=</span>fitdat)</a>
<a class="sourceLine" id="cb2-76" data-line-number="76">    fit2 &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="kw">as.formula</span>(form2), <span class="dt">data=</span>fitdat)</a>
<a class="sourceLine" id="cb2-77" data-line-number="77">    test &lt;-<span class="st"> </span><span class="kw">anova</span>(fit2, fit1)[<span class="dv">2</span>,<span class="dv">6</span>]</a>
<a class="sourceLine" id="cb2-78" data-line-number="78">    ## top predictive variables</a>
<a class="sourceLine" id="cb2-79" data-line-number="79">    scf &lt;-<span class="st"> </span>car<span class="op">::</span><span class="kw">Anova</span>(fit1, <span class="dt">type=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb2-80" data-line-number="80">    nams &lt;-<span class="st"> </span><span class="kw">rownames</span>(scf)</a>
<a class="sourceLine" id="cb2-81" data-line-number="81">    ind &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="st">&quot;trt:X&quot;</span>, nams)</a>
<a class="sourceLine" id="cb2-82" data-line-number="82">    pred_vars &lt;-<span class="st"> </span><span class="kw">substring</span>(nams[ind], <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb2-83" data-line-number="83">    p_inter &lt;-<span class="st"> </span>scf[ind,<span class="dv">4</span>]</a>
<a class="sourceLine" id="cb2-84" data-line-number="84">    ord &lt;-<span class="st"> </span>(<span class="kw">order</span>(p_inter))</a>
<a class="sourceLine" id="cb2-85" data-line-number="85">    top_vars &lt;-<span class="st"> </span>pred_vars[ord]</a>
<a class="sourceLine" id="cb2-86" data-line-number="86">    ## predict individual treatment effects</a>
<a class="sourceLine" id="cb2-87" data-line-number="87">    pred1 &lt;-<span class="st"> </span><span class="kw">predict</span>(fit1, <span class="dt">newdata=</span><span class="kw">cbind</span>(<span class="dt">trt=</span><span class="dv">1</span>,X))</a>
<a class="sourceLine" id="cb2-88" data-line-number="88">    pred0 &lt;-<span class="st"> </span><span class="kw">predict</span>(fit1, <span class="dt">newdata=</span><span class="kw">cbind</span>(<span class="dt">trt=</span><span class="dv">0</span>,X))</a>
<a class="sourceLine" id="cb2-89" data-line-number="89">    tau_hat &lt;-<span class="st"> </span>pred1<span class="op">-</span>pred0</a>
<a class="sourceLine" id="cb2-90" data-line-number="90">  }</a>
<a class="sourceLine" id="cb2-91" data-line-number="91">  <span class="cf">if</span>(family <span class="op">==</span><span class="st"> &quot;binomial&quot;</span>){</a>
<a class="sourceLine" id="cb2-92" data-line-number="92">    fit1 &lt;-<span class="st"> </span><span class="kw">glm</span>(<span class="kw">as.formula</span>(form1), <span class="dt">data=</span>fitdat, <span class="dt">family =</span> binomial)</a>
<a class="sourceLine" id="cb2-93" data-line-number="93">    fit2 &lt;-<span class="st"> </span><span class="kw">glm</span>(<span class="kw">as.formula</span>(form2), <span class="dt">data=</span>fitdat, <span class="dt">family =</span> binomial)</a>
<a class="sourceLine" id="cb2-94" data-line-number="94">    test &lt;-<span class="st"> </span><span class="kw">anova</span>(fit2, fit1,<span class="dt">test=</span><span class="st">&quot;Chisq&quot;</span>)[<span class="dv">2</span>,<span class="dv">5</span>]</a>
<a class="sourceLine" id="cb2-95" data-line-number="95">    ## top predictive variables</a>
<a class="sourceLine" id="cb2-96" data-line-number="96">    scf &lt;-<span class="st"> </span>car<span class="op">::</span><span class="kw">Anova</span>(fit1, <span class="dt">type=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb2-97" data-line-number="97">    nams &lt;-<span class="st"> </span><span class="kw">rownames</span>(scf)</a>
<a class="sourceLine" id="cb2-98" data-line-number="98">    ind &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="st">&quot;trt:X&quot;</span>, nams)</a>
<a class="sourceLine" id="cb2-99" data-line-number="99">    pred_vars &lt;-<span class="st"> </span><span class="kw">substring</span>(nams[ind], <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb2-100" data-line-number="100">    p_inter &lt;-<span class="st"> </span>scf[ind,<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb2-101" data-line-number="101">    ord &lt;-<span class="st"> </span>(<span class="kw">order</span>(p_inter))</a>
<a class="sourceLine" id="cb2-102" data-line-number="102">    top_vars &lt;-<span class="st"> </span>pred_vars[ord]</a>
<a class="sourceLine" id="cb2-103" data-line-number="103">    ## predict individual treatment effects</a>
<a class="sourceLine" id="cb2-104" data-line-number="104">    pred1 &lt;-<span class="st"> </span><span class="kw">predict</span>(fit1, <span class="dt">newdata=</span><span class="kw">cbind</span>(<span class="dt">trt=</span><span class="dv">1</span>,X), <span class="dt">type =</span> <span class="st">&quot;link&quot;</span>)</a>
<a class="sourceLine" id="cb2-105" data-line-number="105">    pred0 &lt;-<span class="st"> </span><span class="kw">predict</span>(fit1, <span class="dt">newdata=</span><span class="kw">cbind</span>(<span class="dt">trt=</span><span class="dv">0</span>,X), <span class="dt">type =</span> <span class="st">&quot;link&quot;</span>)</a>
<a class="sourceLine" id="cb2-106" data-line-number="106">    tau_hat &lt;-<span class="st"> </span>pred1<span class="op">-</span>pred0</a>
<a class="sourceLine" id="cb2-107" data-line-number="107">  }</a>
<a class="sourceLine" id="cb2-108" data-line-number="108">  <span class="cf">if</span>(family <span class="op">==</span><span class="st"> &quot;cox&quot;</span>){</a>
<a class="sourceLine" id="cb2-109" data-line-number="109">    form1 &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;Y&quot;</span>, <span class="st">&quot;Surv(Y, event)&quot;</span>, form1)</a>
<a class="sourceLine" id="cb2-110" data-line-number="110">    form2 &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;Y&quot;</span>, <span class="st">&quot;Surv(Y, event)&quot;</span>, form2)</a>
<a class="sourceLine" id="cb2-111" data-line-number="111">    fit1 &lt;-<span class="st"> </span>survival<span class="op">::</span><span class="kw">coxph</span>(<span class="kw">as.formula</span>(form1), <span class="dt">data=</span>fitdat)</a>
<a class="sourceLine" id="cb2-112" data-line-number="112">    fit2 &lt;-<span class="st"> </span>survival<span class="op">::</span><span class="kw">coxph</span>(<span class="kw">as.formula</span>(form2), <span class="dt">data=</span>fitdat)</a>
<a class="sourceLine" id="cb2-113" data-line-number="113">    test &lt;-<span class="st"> </span><span class="kw">anova</span>(fit2, fit1, <span class="dt">test=</span><span class="st">&quot;Chisq&quot;</span>)<span class="op">$</span><span class="st">&#39;P(&gt;|Chi|)&#39;</span>[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb2-114" data-line-number="114">    ## top predictive variables</a>
<a class="sourceLine" id="cb2-115" data-line-number="115">    nams &lt;-<span class="st"> </span><span class="kw">names</span>(<span class="kw">coef</span>(fit1))</a>
<a class="sourceLine" id="cb2-116" data-line-number="116">    ind &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="st">&quot;trt:X&quot;</span>, nams)</a>
<a class="sourceLine" id="cb2-117" data-line-number="117">    pred_vars &lt;-<span class="st"> </span><span class="kw">substring</span>(nams[ind], <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb2-118" data-line-number="118">    p_inter &lt;-<span class="st"> </span><span class="kw">summary</span>(fit1)<span class="op">$</span>coefficients[ind,<span class="dv">5</span>]</a>
<a class="sourceLine" id="cb2-119" data-line-number="119">    ord &lt;-<span class="st"> </span>(<span class="kw">order</span>(p_inter))</a>
<a class="sourceLine" id="cb2-120" data-line-number="120">    top_vars &lt;-<span class="st"> </span>pred_vars[ord]</a>
<a class="sourceLine" id="cb2-121" data-line-number="121">    ## predict individual treatment effects</a>
<a class="sourceLine" id="cb2-122" data-line-number="122">    tau_hat &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb2-123" data-line-number="123">  }</a>
<a class="sourceLine" id="cb2-124" data-line-number="124">  </a>
<a class="sourceLine" id="cb2-125" data-line-number="125">  ## test significant?</a>
<a class="sourceLine" id="cb2-126" data-line-number="126">  sub_discover &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(test <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.10</span>)</a>
<a class="sourceLine" id="cb2-127" data-line-number="127">  ## predict individual treatment effects</a>
<a class="sourceLine" id="cb2-128" data-line-number="128">  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">sub_discover =</span> sub_discover, </a>
<a class="sourceLine" id="cb2-129" data-line-number="129">              <span class="dt">top_vars =</span> <span class="kw">get_var_back</span>(top_vars),</a>
<a class="sourceLine" id="cb2-130" data-line-number="130">              <span class="dt">est_trt_effect =</span> tau_hat))</a>
<a class="sourceLine" id="cb2-131" data-line-number="131">}</a>
<a class="sourceLine" id="cb2-132" data-line-number="132"></a>
<a class="sourceLine" id="cb2-133" data-line-number="133">var_select_lasso_tree &lt;-<span class="st"> </span><span class="cf">function</span>(X, Y, trt, event, family){</a>
<a class="sourceLine" id="cb2-134" data-line-number="134">  ind &lt;-<span class="st"> </span>trt <span class="op">==</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb2-135" data-line-number="135">  X0 &lt;-<span class="st"> </span>X[ind,]</a>
<a class="sourceLine" id="cb2-136" data-line-number="136">  X1 &lt;-<span class="st"> </span>X[<span class="op">!</span>ind,]</a>
<a class="sourceLine" id="cb2-137" data-line-number="137">  Y0 &lt;-<span class="st"> </span>Y[ind]</a>
<a class="sourceLine" id="cb2-138" data-line-number="138">  Y1 &lt;-<span class="st"> </span>Y[<span class="op">!</span>ind]</a>
<a class="sourceLine" id="cb2-139" data-line-number="139">  X0 &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span>., <span class="dt">data=</span>X0)[,<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb2-140" data-line-number="140">  X1 &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span>., <span class="dt">data=</span>X1)[,<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb2-141" data-line-number="141">  <span class="cf">if</span>(family <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;binomial&quot;</span>, <span class="st">&quot;gaussian&quot;</span>)){</a>
<a class="sourceLine" id="cb2-142" data-line-number="142">    fit0 &lt;-<span class="st"> </span>glmnet<span class="op">::</span><span class="kw">cv.glmnet</span>(X0, Y0, <span class="dt">family =</span> family)</a>
<a class="sourceLine" id="cb2-143" data-line-number="143">    fit1 &lt;-<span class="st"> </span>glmnet<span class="op">::</span><span class="kw">cv.glmnet</span>(X1, Y1, <span class="dt">family =</span> family)</a>
<a class="sourceLine" id="cb2-144" data-line-number="144">  }</a>
<a class="sourceLine" id="cb2-145" data-line-number="145">  <span class="cf">if</span>(family <span class="op">==</span><span class="st"> &quot;cox&quot;</span>){</a>
<a class="sourceLine" id="cb2-146" data-line-number="146">    event0 &lt;-<span class="st"> </span>event[ind]</a>
<a class="sourceLine" id="cb2-147" data-line-number="147">    event1 &lt;-<span class="st"> </span>event[<span class="op">!</span>ind]</a>
<a class="sourceLine" id="cb2-148" data-line-number="148">    fit0 &lt;-<span class="st"> </span>glmnet<span class="op">::</span><span class="kw">cv.glmnet</span>(X0, <span class="kw">Surv</span>(Y0, event0), <span class="dt">family =</span> <span class="st">&quot;cox&quot;</span>)</a>
<a class="sourceLine" id="cb2-149" data-line-number="149">    fit1 &lt;-<span class="st"> </span>glmnet<span class="op">::</span><span class="kw">cv.glmnet</span>(X1, <span class="kw">Surv</span>(Y1, event1), <span class="dt">family =</span> <span class="st">&quot;cox&quot;</span>)</a>
<a class="sourceLine" id="cb2-150" data-line-number="150">  }</a>
<a class="sourceLine" id="cb2-151" data-line-number="151">  </a>
<a class="sourceLine" id="cb2-152" data-line-number="152">  get_fit_vars &lt;-<span class="st"> </span><span class="cf">function</span>(fit){</a>
<a class="sourceLine" id="cb2-153" data-line-number="153">    cf &lt;-<span class="st"> </span><span class="kw">coef</span>(fit, <span class="dt">s=</span><span class="st">&quot;lambda.1se&quot;</span>)</a>
<a class="sourceLine" id="cb2-154" data-line-number="154">    ## selected variables</a>
<a class="sourceLine" id="cb2-155" data-line-number="155">    vars &lt;-<span class="st"> </span><span class="kw">rownames</span>(cf)[<span class="kw">abs</span>(<span class="kw">as.numeric</span>(cf))<span class="op">&gt;</span><span class="dv">0</span>]</a>
<a class="sourceLine" id="cb2-156" data-line-number="156">  </a>
<a class="sourceLine" id="cb2-157" data-line-number="157">  }</a>
<a class="sourceLine" id="cb2-158" data-line-number="158">  <span class="kw">setdiff</span>(<span class="kw">union</span>(<span class="kw">get_fit_vars</span>(fit0), <span class="kw">get_fit_vars</span>(fit1)),<span class="st">&quot;(Intercept)&quot;</span>)</a>
<a class="sourceLine" id="cb2-159" data-line-number="159">}</a>
<a class="sourceLine" id="cb2-160" data-line-number="160"></a>
<a class="sourceLine" id="cb2-161" data-line-number="161"></a>
<a class="sourceLine" id="cb2-162" data-line-number="162"><span class="co">#&#39; MOB on continuous/binary/tte response where node use model Y = trt + prog(most significant prognostic variables)</span></a>
<a class="sourceLine" id="cb2-163" data-line-number="163">wbreg &lt;-<span class="st"> </span><span class="cf">function</span>(y, x, <span class="dt">start =</span> <span class="ot">NULL</span>, <span class="dt">weights =</span> <span class="ot">NULL</span>, <span class="dt">offset =</span> <span class="ot">NULL</span>, ...) {</a>
<a class="sourceLine" id="cb2-164" data-line-number="164">  <span class="kw">survreg</span>(y <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x, <span class="dt">weights =</span> weights, <span class="dt">dist =</span> <span class="st">&quot;exponential&quot;</span>, ...)</a>
<a class="sourceLine" id="cb2-165" data-line-number="165">}</a>
<a class="sourceLine" id="cb2-166" data-line-number="166"></a>
<a class="sourceLine" id="cb2-167" data-line-number="167">logLik.survreg &lt;-<span class="st"> </span><span class="cf">function</span>(object, ...) {</a>
<a class="sourceLine" id="cb2-168" data-line-number="168">  <span class="kw">structure</span>(object<span class="op">$</span>loglik[<span class="dv">2</span>], <span class="dt">df =</span> <span class="kw">sum</span>(object<span class="op">$</span>df), <span class="dt">class =</span> <span class="st">&quot;logLik&quot;</span>)</a>
<a class="sourceLine" id="cb2-169" data-line-number="169">}</a>
<a class="sourceLine" id="cb2-170" data-line-number="170"></a>
<a class="sourceLine" id="cb2-171" data-line-number="171">mobl &lt;-<span class="st"> </span><span class="cf">function</span>(X, Y, trt, <span class="dt">event =</span> <span class="ot">NULL</span>, family){</a>
<a class="sourceLine" id="cb2-172" data-line-number="172">  ## select union of variables that impact outcome on treatment and</a>
<a class="sourceLine" id="cb2-173" data-line-number="173">  ## control (this will be a superset of the purely prognostic variables)</a>
<a class="sourceLine" id="cb2-174" data-line-number="174">  var_prog &lt;-<span class="st"> </span><span class="kw">var_select_lasso_tree</span>(X, Y, trt, event, family)</a>
<a class="sourceLine" id="cb2-175" data-line-number="175">  </a>
<a class="sourceLine" id="cb2-176" data-line-number="176">  var_prog &lt;-<span class="st">  </span><span class="kw">get_var_back</span>(var_prog)</a>
<a class="sourceLine" id="cb2-177" data-line-number="177">  </a>
<a class="sourceLine" id="cb2-178" data-line-number="178">  <span class="co">#print(var_prog)</span></a>
<a class="sourceLine" id="cb2-179" data-line-number="179">  temp =<span class="st"> </span><span class="kw">which</span>(<span class="kw">substring</span>(var_prog,<span class="dv">1</span>,<span class="dv">2</span>) <span class="op">==</span><span class="st">&quot;X6&quot;</span>)</a>
<a class="sourceLine" id="cb2-180" data-line-number="180">  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(temp)){</a>
<a class="sourceLine" id="cb2-181" data-line-number="181">    var_prog[temp] =<span class="st"> &quot;X6&quot;</span></a>
<a class="sourceLine" id="cb2-182" data-line-number="182">  }</a>
<a class="sourceLine" id="cb2-183" data-line-number="183">    </a>
<a class="sourceLine" id="cb2-184" data-line-number="184">  <span class="co">#print(var_prog)</span></a>
<a class="sourceLine" id="cb2-185" data-line-number="185">  cov.names &lt;-<span class="st"> </span><span class="kw">colnames</span>(X)</a>
<a class="sourceLine" id="cb2-186" data-line-number="186">  <span class="cf">if</span>(family <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;binomial&quot;</span>, <span class="st">&quot;gaussian&quot;</span>)){</a>
<a class="sourceLine" id="cb2-187" data-line-number="187">    dat &lt;-<span class="st"> </span><span class="kw">cbind</span>(Y, trt, X)</a>
<a class="sourceLine" id="cb2-188" data-line-number="188">    <span class="cf">if</span>(<span class="kw">length</span>(var_prog) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){</a>
<a class="sourceLine" id="cb2-189" data-line-number="189">      eqn &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y ~ trt| &quot;</span>,</a>
<a class="sourceLine" id="cb2-190" data-line-number="190">                    <span class="kw">paste0</span>(cov.names, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>))</a>
<a class="sourceLine" id="cb2-191" data-line-number="191">    }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb2-192" data-line-number="192">      eqn &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y ~ trt + &quot;</span>,<span class="kw">paste0</span>(var_prog, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>),<span class="st">&quot; | &quot;</span>,</a>
<a class="sourceLine" id="cb2-193" data-line-number="193">                    <span class="kw">paste0</span>(cov.names, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>))</a>
<a class="sourceLine" id="cb2-194" data-line-number="194">    }</a>
<a class="sourceLine" id="cb2-195" data-line-number="195">    </a>
<a class="sourceLine" id="cb2-196" data-line-number="196">    glmtr &lt;-<span class="st"> </span>partykit<span class="op">::</span><span class="kw">glmtree</span>(<span class="kw">as.formula</span>(eqn), <span class="dt">data =</span> dat, <span class="dt">family =</span> family,</a>
<a class="sourceLine" id="cb2-197" data-line-number="197">                               <span class="dt">parm =</span> <span class="dv">2</span>, <span class="dt">minsize =</span> <span class="fl">0.2</span><span class="op">*</span><span class="kw">nrow</span>(dat), <span class="dt">alpha=</span><span class="fl">0.10</span>, <span class="dt">bonferroni=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb2-198" data-line-number="198">  }</a>
<a class="sourceLine" id="cb2-199" data-line-number="199">  <span class="cf">if</span> (family <span class="op">==</span><span class="st"> &#39;cox&#39;</span>){</a>
<a class="sourceLine" id="cb2-200" data-line-number="200">    dat &lt;-<span class="st"> </span><span class="kw">cbind</span>(Y,event, trt, X)</a>
<a class="sourceLine" id="cb2-201" data-line-number="201">    family =<span class="st"> </span>wbreg</a>
<a class="sourceLine" id="cb2-202" data-line-number="202">    <span class="cf">if</span>(<span class="kw">length</span>(var_prog) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){</a>
<a class="sourceLine" id="cb2-203" data-line-number="203">      eqn &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Surv(Y, event) ~ trt| &quot;</span>,</a>
<a class="sourceLine" id="cb2-204" data-line-number="204">                    <span class="kw">paste0</span>(cov.names, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>))</a>
<a class="sourceLine" id="cb2-205" data-line-number="205">    }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb2-206" data-line-number="206">      eqn &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Surv(Y, event) ~ trt + &quot;</span>,<span class="kw">paste0</span>(var_prog, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>),<span class="st">&quot; | &quot;</span>,</a>
<a class="sourceLine" id="cb2-207" data-line-number="207">                    <span class="kw">paste0</span>(cov.names, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>))</a>
<a class="sourceLine" id="cb2-208" data-line-number="208">    }</a>
<a class="sourceLine" id="cb2-209" data-line-number="209">    glmtr &lt;-<span class="st"> </span>partykit<span class="op">::</span><span class="kw">mob</span>(<span class="kw">as.formula</span>(eqn), <span class="dt">data =</span> dat,</a>
<a class="sourceLine" id="cb2-210" data-line-number="210">                           <span class="dt">fit =</span> wbreg, <span class="dt">control =</span> partykit<span class="op">::</span><span class="kw">mob_control</span>(<span class="dt">parm =</span> <span class="dv">2</span>, </a>
<a class="sourceLine" id="cb2-211" data-line-number="211">                                                                        <span class="dt">minsize =</span> <span class="fl">0.2</span><span class="op">*</span><span class="kw">nrow</span>(dat),</a>
<a class="sourceLine" id="cb2-212" data-line-number="212">                                                                        <span class="dt">alpha=</span><span class="fl">0.10</span>, <span class="dt">bonferroni=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb2-213" data-line-number="213">  }</a>
<a class="sourceLine" id="cb2-214" data-line-number="214">  </a>
<a class="sourceLine" id="cb2-215" data-line-number="215">  ## 1. Test for existence of differential treatment effects</a>
<a class="sourceLine" id="cb2-216" data-line-number="216">  sub_discover &lt;-<span class="st"> </span>(<span class="kw">length</span>(glmtr)<span class="op">&gt;</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb2-217" data-line-number="217">  </a>
<a class="sourceLine" id="cb2-218" data-line-number="218">  ## 2. identify the 10 most important variable</a>
<a class="sourceLine" id="cb2-219" data-line-number="219">  ##### ectract infortion of test statistic from node to get the important variabl</a>
<a class="sourceLine" id="cb2-220" data-line-number="220">  statistic_matrix &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">t</span>(strucchange<span class="op">::</span><span class="kw">sctest</span>(glmtr, <span class="dt">node =</span> <span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb2-221" data-line-number="221">  statistic_matrix<span class="op">$</span>vars &lt;-<span class="st"> </span><span class="kw">rownames</span>(statistic_matrix)</a>
<a class="sourceLine" id="cb2-222" data-line-number="222">  </a>
<a class="sourceLine" id="cb2-223" data-line-number="223">  top_10vars &lt;-<span class="st"> </span>cov.names[<span class="kw">order</span>(<span class="kw">rank</span>(statistic_matrix<span class="op">$</span>p.value, <span class="dt">na.last =</span> <span class="ot">TRUE</span>, <span class="dt">ties.method =</span> <span class="kw">c</span>(<span class="st">&quot;random&quot;</span>)))][<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]</a>
<a class="sourceLine" id="cb2-224" data-line-number="224">  ## find treatment estimate in each node</a>
<a class="sourceLine" id="cb2-225" data-line-number="225">  <span class="cf">if</span>(<span class="op">!</span>sub_discover){</a>
<a class="sourceLine" id="cb2-226" data-line-number="226">    sub_node &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">length</span>(Y))</a>
<a class="sourceLine" id="cb2-227" data-line-number="227">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb2-228" data-line-number="228">    node_trt_effect &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">summary</span>(glmtr), <span class="cf">function</span>(x) <span class="kw">coef</span>(x)[<span class="dv">2</span>,<span class="dv">1</span>]))</a>
<a class="sourceLine" id="cb2-229" data-line-number="229">    sub_node &lt;-<span class="st"> </span><span class="kw">names</span>(node_trt_effect)[<span class="kw">which</span>(node_trt_effect <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(node_trt_effect))]</a>
<a class="sourceLine" id="cb2-230" data-line-number="230">  }</a>
<a class="sourceLine" id="cb2-231" data-line-number="231">  </a>
<a class="sourceLine" id="cb2-232" data-line-number="232">  tau.hat &lt;-<span class="st"> </span><span class="kw">predict</span>(glmtr, <span class="dt">newdata =</span> dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">trt =</span> <span class="dv">1</span>), <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>) <span class="op">-</span></a>
<a class="sourceLine" id="cb2-233" data-line-number="233"><span class="st">    </span><span class="kw">predict</span>(glmtr, <span class="dt">newdata =</span> dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">trt =</span> <span class="dv">0</span>), <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</a>
<a class="sourceLine" id="cb2-234" data-line-number="234">  </a>
<a class="sourceLine" id="cb2-235" data-line-number="235">  </a>
<a class="sourceLine" id="cb2-236" data-line-number="236">  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">sub_discover =</span> sub_discover, </a>
<a class="sourceLine" id="cb2-237" data-line-number="237">              <span class="dt">top_vars =</span> top_10vars,</a>
<a class="sourceLine" id="cb2-238" data-line-number="238">              <span class="dt">est_trt_effect =</span> tau.hat))</a>
<a class="sourceLine" id="cb2-239" data-line-number="239">}</a>
<a class="sourceLine" id="cb2-240" data-line-number="240"></a>
<a class="sourceLine" id="cb2-241" data-line-number="241"></a>
<a class="sourceLine" id="cb2-242" data-line-number="242"></a>
<a class="sourceLine" id="cb2-243" data-line-number="243">sim_run_cont &lt;-<span class="st"> </span><span class="cf">function</span>(data,nsim){</a>
<a class="sourceLine" id="cb2-244" data-line-number="244">  n =<span class="st"> </span><span class="kw">dim</span>(data[[<span class="dv">1</span>]])[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb2-245" data-line-number="245">  p =<span class="st"> </span><span class="kw">dim</span>(data[[<span class="dv">1</span>]])[<span class="dv">2</span>]<span class="op">-</span><span class="dv">4</span></a>
<a class="sourceLine" id="cb2-246" data-line-number="246">  </a>
<a class="sourceLine" id="cb2-247" data-line-number="247">  res_multi=<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,nsim,n)</a>
<a class="sourceLine" id="cb2-248" data-line-number="248">  res_mse_multi =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,nsim)</a>
<a class="sourceLine" id="cb2-249" data-line-number="249">  res_mobl=<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,nsim,n)</a>
<a class="sourceLine" id="cb2-250" data-line-number="250">  res_mse_mobl =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,nsim)</a>
<a class="sourceLine" id="cb2-251" data-line-number="251">  </a>
<a class="sourceLine" id="cb2-252" data-line-number="252">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nsim){</a>
<a class="sourceLine" id="cb2-253" data-line-number="253">    <span class="co">#print(i)</span></a>
<a class="sourceLine" id="cb2-254" data-line-number="254">    dat_use =<span class="st"> </span>data[[i]]</a>
<a class="sourceLine" id="cb2-255" data-line-number="255">    Y =<span class="st"> </span>dat_use<span class="op">$</span>Y</a>
<a class="sourceLine" id="cb2-256" data-line-number="256">    trt =<span class="st"> </span>dat_use<span class="op">$</span>trt</a>
<a class="sourceLine" id="cb2-257" data-line-number="257">    X =<span class="st"> </span>dat_use[,<span class="dv">2</span><span class="op">:</span>(p<span class="op">+</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb2-258" data-line-number="258">    </a>
<a class="sourceLine" id="cb2-259" data-line-number="259">    res_multivariate =<span class="st"> </span><span class="kw">multivariate</span>(X,Y,trt,<span class="dt">event =</span> <span class="ot">NULL</span>, <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span> )</a>
<a class="sourceLine" id="cb2-260" data-line-number="260">    res_mobl_temp =<span class="st"> </span><span class="kw">mobl</span>(X, Y, trt, <span class="dt">event =</span> <span class="ot">NULL</span>, <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>)</a>
<a class="sourceLine" id="cb2-261" data-line-number="261">    </a>
<a class="sourceLine" id="cb2-262" data-line-number="262">    res_multi[i,] =<span class="st"> </span>res_multivariate<span class="op">$</span>est_trt_effect</a>
<a class="sourceLine" id="cb2-263" data-line-number="263">    res_mse_multi[i] =<span class="st"> </span><span class="dv">1</span><span class="op">/</span>n<span class="op">*</span><span class="kw">sum</span>((res_multivariate<span class="op">$</span>est_trt_effect <span class="op">-</span>dat_use<span class="op">$</span>trt_effect)<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb2-264" data-line-number="264">    </a>
<a class="sourceLine" id="cb2-265" data-line-number="265">    res_mobl[i,] =<span class="st"> </span>res_mobl_temp<span class="op">$</span>est_trt_effect</a>
<a class="sourceLine" id="cb2-266" data-line-number="266">    res_mse_mobl[i] =<span class="st"> </span><span class="dv">1</span><span class="op">/</span>n<span class="op">*</span><span class="kw">sum</span>((res_mobl_temp<span class="op">$</span>est_trt_effect <span class="op">-</span>dat_use<span class="op">$</span>trt_effect)<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb2-267" data-line-number="267">    </a>
<a class="sourceLine" id="cb2-268" data-line-number="268">  }</a>
<a class="sourceLine" id="cb2-269" data-line-number="269">  </a>
<a class="sourceLine" id="cb2-270" data-line-number="270">  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">res_multi =</span> res_multi,<span class="dt">res_mse_multi =</span> res_mse_multi,</a>
<a class="sourceLine" id="cb2-271" data-line-number="271">              <span class="dt">res_mobl =</span> res_mobl,<span class="dt">res_mse_mobl =</span> res_mse_mobl))</a>
<a class="sourceLine" id="cb2-272" data-line-number="272">}</a>
<a class="sourceLine" id="cb2-273" data-line-number="273"></a>
<a class="sourceLine" id="cb2-274" data-line-number="274"><span class="kw">set.seed</span>(<span class="dv">2222</span>) <span class="co">#set seed for random algorithms</span></a>
<a class="sourceLine" id="cb2-275" data-line-number="275">res1 =<span class="st"> </span><span class="kw">sim_run_cont</span>(dat1,<span class="dt">nsim=</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb2-276" data-line-number="276">res2 =<span class="st"> </span><span class="kw">sim_run_cont</span>(dat2,<span class="dt">nsim=</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb2-277" data-line-number="277">res3 =<span class="st"> </span><span class="kw">sim_run_cont</span>(dat3,<span class="dt">nsim=</span><span class="dv">100</span>)</a></code></pre></div>
<p>We could make a plot to compare the MSE of the estimated treatment effect vs. the true treatment effect.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">data_plot =<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">matrix</span>(<span class="dv">0</span>,<span class="dv">2</span><span class="op">*</span><span class="dv">3</span>,<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">names</span>(data_plot) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;MSE&quot;</span>,<span class="st">&quot;n&quot;</span>,<span class="st">&quot;method&quot;</span>)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">data_plot[<span class="dv">1</span>,<span class="dv">1</span>] =<span class="st"> </span><span class="kw">mean</span>(res1<span class="op">$</span>res_mse_multi)</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">data_plot[<span class="dv">1</span>,<span class="dv">2</span>] =<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">data_plot[<span class="dv">1</span>,<span class="dv">3</span>] =<span class="st"> &quot;Multivariate&quot;</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">data_plot[<span class="dv">2</span>,<span class="dv">1</span>] =<span class="st"> </span><span class="kw">mean</span>(res2<span class="op">$</span>res_mse_multi)</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">data_plot[<span class="dv">2</span>,<span class="dv">2</span>] =<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12">data_plot[<span class="dv">2</span>,<span class="dv">3</span>] =<span class="st"> &quot;Multivariate&quot;</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">data_plot[<span class="dv">3</span>,<span class="dv">1</span>] =<span class="st"> </span><span class="kw">mean</span>(res3<span class="op">$</span>res_mse_multi)</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">data_plot[<span class="dv">3</span>,<span class="dv">2</span>] =<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16">data_plot[<span class="dv">3</span>,<span class="dv">3</span>] =<span class="st"> &quot;Multivariate&quot;</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"></a>
<a class="sourceLine" id="cb3-18" data-line-number="18">data_plot[<span class="dv">4</span>,<span class="dv">1</span>] =<span class="st"> </span><span class="kw">mean</span>(res1<span class="op">$</span>res_mse_mobl)</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">data_plot[<span class="dv">4</span>,<span class="dv">2</span>] =<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">data_plot[<span class="dv">4</span>,<span class="dv">3</span>] =<span class="st"> &quot;Mobl&quot;</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">data_plot[<span class="dv">5</span>,<span class="dv">1</span>] =<span class="st"> </span><span class="kw">mean</span>(res2<span class="op">$</span>res_mse_mobl)</a>
<a class="sourceLine" id="cb3-23" data-line-number="23">data_plot[<span class="dv">5</span>,<span class="dv">2</span>] =<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24">data_plot[<span class="dv">5</span>,<span class="dv">3</span>] =<span class="st"> &quot;Mobl&quot;</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"></a>
<a class="sourceLine" id="cb3-26" data-line-number="26">data_plot[<span class="dv">6</span>,<span class="dv">1</span>] =<span class="st"> </span><span class="kw">mean</span>(res3<span class="op">$</span>res_mse_mobl)</a>
<a class="sourceLine" id="cb3-27" data-line-number="27">data_plot[<span class="dv">6</span>,<span class="dv">2</span>] =<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb3-28" data-line-number="28">data_plot[<span class="dv">6</span>,<span class="dv">3</span>] =<span class="st"> &quot;Mobl&quot;</span></a>
<a class="sourceLine" id="cb3-29" data-line-number="29"></a>
<a class="sourceLine" id="cb3-30" data-line-number="30">p =<span class="st"> </span><span class="kw">ggplot</span>(data_plot, <span class="kw">aes</span>(<span class="dt">x=</span>n, <span class="dt">y=</span>MSE,<span class="dt">color =</span> method)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a>
<a class="sourceLine" id="cb3-31" data-line-number="31">p</a></code></pre></div>
<p><img src="Examples_Simulation_files/figure-html/unnamed-chunk-4-1.png" width="700" /></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul>
      <li><a href="#simulation-example-using-benchtm">Simulation example using “benchtm”</a></li>
      </ul>
    </div>
      </div>

</div>


      <footer>
      <div class="copyright">
  <p>Developed by Sophie Sun, Bjoern Bornkamp, Jiarui Lu, Ardalan Mirshani, Kostas Sechidis, Yao Chen, Novartis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
   </div>

  

  </body>
</html>
