<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generate new outcome data for existing covariates • benchtm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Generate new outcome data for existing covariates">
<meta property="og:description" content="benchtm">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">benchtm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a01_User_guidance.html">Get started with benchtm</a>
    </li>
    <li>
      <a href="../articles/a02_Examples_Real_Data.html">Generate new outcome data for existing covariates</a>
    </li>
    <li>
      <a href="../articles/a03_Examples_Simulation.html">Using benchtm for a Simulation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Generate new outcome data for existing
covariates</h1>
            
      
      
      <div class="hidden name"><code>a02_Examples_Real_Data.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="data-generation-using-benchtm-based-on-real-clinical-data">Data Generation using “benchtm” Based on Real Clinical Data<a class="anchor" aria-label="anchor" href="#data-generation-using-benchtm-based-on-real-clinical-data"></a>
</h2>
<p>In this section we demonstrate how to use “benchtm” package for
reproducible data analysis using real clinical data. The package can
generate outcomes based on user-specific covariates. This would allow
users to perform simulation study using real data as inputs and validate
existing findings. For example it allows to simulate data for the
scenario under no treatment effect heterogeneity (no treatment by
covariate interaction). The simulated data can then be analysed in the
same way as the original data. This will allow to put potential finding
on the original data into context (e.g. how consistent are analysis
results with the hypothesis of no treatment by covariate
interactions).</p>
<p>As demonstration, we will use data from <a href="http://portal.uni-freiburg.de/imbi/Royston-Sauerbrei-book" class="external-link">Prostate
cancer patients</a>. The treatment consisted of a placebo group and
three dose levels of diethyl stilbestrol. The placebo and the lowest
dose level of diethyl stilbestrol were combined to give the control arm,
and the higher doses were combined to give an active treatment arm. Of
506 patients randomized, only 475 with complete data are available on
the dataset. Based on the analysis provided in <a href="https://onlinelibrary.wiley.com/doi/epdf/10.1002/bimj.201500147" class="external-link">Exploratory
subgroup analysis in clinical trials by model selection</a>, we only
consider Bone metastasis (BM), History of cardiovascular disease (HX),
and Age (AGE &gt; 65) as covariates. The endpoint is survival time
(SURVTIME) with censoring (CENS = 1:death; CENS = 0 censor). Treatment
is recoded as RX.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">benchtm</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org" class="external-link">haven</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## BM:Bone metastasis, </span></span>
<span><span class="co">## HX:History of cardiovascular disease</span></span>
<span><span class="co">## AGE:Age, years based on model; </span></span>
<span><span class="co">## RX:treatment</span></span>
<span><span class="co">## SURVTIME: survival time, </span></span>
<span><span class="co">## CENS: 0 for censor and 1 for death </span></span>
<span><span class="co">## reference https://onlinelibrary.wiley.com/doi/10.1002/bimj.201500147</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://haven.tidyverse.org/reference/read_sas.html" class="external-link">read_sas</a></span><span class="op">(</span><span class="st">"adv_prostate_ca.sas7bdat"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co">## the SAS data in provided in https://onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1002%2Fbimj.201500147&amp;file=bimj1691-sup-0001-CodeData.zip</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">BM</span>, <span class="va">HX</span>, <span class="va">AGE</span>, <span class="va">SURVTIME</span>, <span class="va">CENS</span>, <span class="va">RX</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>AGE_cat <span class="op">=</span> <span class="fl">1</span><span class="op">*</span><span class="op">(</span><span class="va">AGE</span> <span class="op">&gt;</span> <span class="fl">65</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;      BM    HX   AGE SURVTIME  CENS    RX AGE_cat</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     0     0    75     72.5     0     0       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     0     1    69     40.5     1     1       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     0     1    75     20.5     1     0       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     0     0    67     65.5     0     0       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     0     0    71     24.5     1     0       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     0     0    75     46.5     1     0       1</span></span></code></pre></div>
<p>A survival model is fitted assuming exponential distribution. Model
with and without interactions are conducted respectively.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## fit main model (just main/prognostic effects)</span></span>
<span><span class="va">model.main</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survreg.html" class="external-link">survreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">SURVTIME</span>, <span class="va">CENS</span><span class="op">)</span> <span class="op">~</span> <span class="va">RX</span> <span class="op">+</span> <span class="va">BM</span> <span class="op">+</span> <span class="va">HX</span> <span class="op">+</span> <span class="va">AGE_cat</span>, dist <span class="op">=</span> <span class="st">"exponential"</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model.main</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; survreg(formula = Surv(SURVTIME, CENS) ~ RX + BM + HX + AGE_cat, </span></span>
<span><span class="co">#&gt;     data = dat, dist = "exponential")</span></span>
<span><span class="co">#&gt;              Value Std. Error     z       p</span></span>
<span><span class="co">#&gt; (Intercept)  4.376      0.161 27.22 &lt; 2e-16</span></span>
<span><span class="co">#&gt; RX           0.193      0.112  1.73   0.084</span></span>
<span><span class="co">#&gt; BM          -0.719      0.140 -5.15 2.7e-07</span></span>
<span><span class="co">#&gt; HX          -0.465      0.110 -4.21 2.5e-05</span></span>
<span><span class="co">#&gt; AGE_cat     -0.269      0.152 -1.76   0.078</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scale fixed at 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Exponential distribution</span></span>
<span><span class="co">#&gt; Loglik(model)= -1644.3   Loglik(intercept only)= -1667</span></span>
<span><span class="co">#&gt;  Chisq= 45.35 on 4 degrees of freedom, p= 3.4e-09 </span></span>
<span><span class="co">#&gt; Number of Newton-Raphson Iterations: 4 </span></span>
<span><span class="co">#&gt; n= 475</span></span>
<span></span>
<span><span class="co">## model with interactions</span></span>
<span><span class="va">model.inter</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survreg.html" class="external-link">survreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">SURVTIME</span>, <span class="va">CENS</span><span class="op">)</span> <span class="op">~</span> <span class="va">RX</span> <span class="op">*</span> <span class="op">(</span><span class="va">BM</span> <span class="op">+</span>  <span class="va">HX</span> <span class="op">+</span>  <span class="va">AGE_cat</span><span class="op">)</span>, </span>
<span>                      dist <span class="op">=</span> <span class="st">"exponential"</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model.inter</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; survreg(formula = Surv(SURVTIME, CENS) ~ RX * (BM + HX + AGE_cat), </span></span>
<span><span class="co">#&gt;     data = dat, dist = "exponential")</span></span>
<span><span class="co">#&gt;              Value Std. Error     z       p</span></span>
<span><span class="co">#&gt; (Intercept)  4.030      0.189 21.29 &lt; 2e-16</span></span>
<span><span class="co">#&gt; RX           0.897      0.309  2.90  0.0037</span></span>
<span><span class="co">#&gt; BM          -1.083      0.199 -5.44 5.4e-08</span></span>
<span><span class="co">#&gt; HX          -0.347      0.151 -2.30  0.0217</span></span>
<span><span class="co">#&gt; AGE_cat      0.130      0.193  0.67  0.5027</span></span>
<span><span class="co">#&gt; RX:BM        0.603      0.276  2.19  0.0288</span></span>
<span><span class="co">#&gt; RX:HX       -0.268      0.220 -1.22  0.2242</span></span>
<span><span class="co">#&gt; RX:AGE_cat  -0.810      0.315 -2.57  0.0100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scale fixed at 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Exponential distribution</span></span>
<span><span class="co">#&gt; Loglik(model)= -1636.8   Loglik(intercept only)= -1667</span></span>
<span><span class="co">#&gt;  Chisq= 60.29 on 7 degrees of freedom, p= 1.3e-10 </span></span>
<span><span class="co">#&gt; Number of Newton-Raphson Iterations: 4 </span></span>
<span><span class="co">#&gt; n= 475</span></span></code></pre></div>
<p>From the main model, we can see that Bone metastasis (BM), History of
cardiovascular disease (HX) are significant under exponential
assumption, with interaction included, we can see that Bone metastasis
(BM) and Age have significant interaction with treatment (P-value &lt;
0.05). Based on the point estimates from the interaction model, we could
use “benchtm” package to generate new outcomes based on the existing
covariates in this dataset.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="co"># library(survminer)</span></span>
<span></span>
<span><span class="co"># coefficients obtained from model.inter</span></span>
<span><span class="va">prog_use</span> <span class="op">&lt;-</span> <span class="st">" 1.0830 *BM + 0.347 *HX - 0.13*AGE_cat"</span></span>
<span><span class="va">pred_use</span> <span class="op">&lt;-</span> <span class="st">"-0.603 * BM + 0.27 * HX + 0.81 * AGE_cat"</span></span>
<span><span class="va">b0_use</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">0.897</span></span>
<span><span class="va">b1_use</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">lambda0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4.030</span><span class="op">)</span></span>
<span><span class="va">max_surv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">SURVTIME</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cens_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">n</span>, rate <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">max_surv</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">dat_generate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_y.html">generate_y</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">BM</span>, <span class="va">HX</span>, <span class="va">AGE_cat</span><span class="op">)</span>, trt <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">RX</span>, </span>
<span>                           prog <span class="op">=</span> <span class="va">prog_use</span>, pred <span class="op">=</span> <span class="va">pred_use</span>, b0 <span class="op">=</span> <span class="va">b0_use</span>, b1 <span class="op">=</span> <span class="va">b1_use</span>,</span>
<span>                          type <span class="op">=</span> <span class="st">"survival"</span>, cens_time <span class="op">=</span> <span class="va">cens_time</span>, lambda0 <span class="op">=</span> <span class="va">lambda0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_generate</span><span class="op">)</span></span>
<span><span class="co">#&gt;   trt BM HX AGE_cat         Y event</span></span>
<span><span class="co">#&gt; 1   0  0  0       1 48.385650     1</span></span>
<span><span class="co">#&gt; 2   1  0  1       1 44.563077     1</span></span>
<span><span class="co">#&gt; 3   0  0  1       1  6.598488     1</span></span>
<span><span class="co">#&gt; 4   0  0  0       1  8.956895     1</span></span>
<span><span class="co">#&gt; 5   0  0  0       1 16.824969     0</span></span>
<span><span class="co">#&gt; 6   0  0  0       1 43.418168     0</span></span></code></pre></div>
<p>To check if the generated data is close to the real data, a
Kaplan-Meier curve can be used to compare the survival
probabilities.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_combine</span> <span class="op">&lt;-</span> <span class="va">dat_generate</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">event</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>SURVTIME <span class="op">=</span> <span class="va">Y</span>, CENS <span class="op">=</span> <span class="va">event</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">SURVTIME</span>, <span class="va">CENS</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Generated"</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Observed"</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## compare ovserved and generated survival time </span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">SURVTIME</span>, <span class="va">CENS</span><span class="op">)</span> <span class="op">~</span> <span class="va">cat</span>, data <span class="op">=</span> <span class="va">dat_combine</span><span class="op">)</span></span>
<span><span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html" class="external-link">ggsurvplot</a></span><span class="op">(</span><span class="va">fit</span>, data <span class="op">=</span> <span class="va">dat_combine</span>, size <span class="op">=</span> <span class="fl">1</span>, palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#E7B800"</span>, <span class="st">"#2E9FDF"</span><span class="op">)</span>, </span>
<span>          conf.int <span class="op">=</span> <span class="cn">TRUE</span>,  pval <span class="op">=</span> <span class="cn">TRUE</span>,  risk.table <span class="op">=</span> <span class="cn">TRUE</span>,  risk.table.col <span class="op">=</span> <span class="st">"strata"</span>,</span>
<span>          legend.labs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Generated"</span>, <span class="st">"Observed"</span><span class="op">)</span>,  risk.table.height <span class="op">=</span> <span class="fl">0.25</span>,  </span>
<span>          ggtheme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="a02_Examples_Real_Data_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>We can see from the above plot that the generated survival times have
very similar distribution compared to the observed survival times.</p>
</div>
<div class="section level2">
<h2 id="heterogeneity-test-using-benchtm">Heterogeneity Test using “benchtm”<a class="anchor" aria-label="anchor" href="#heterogeneity-test-using-benchtm"></a>
</h2>
<p>One can also conduct a parametric bootstrap test for existence of
treatment effect heterogeneity by calculating the log-likelihood ratio
under the model with and without interation. The null distribution of
this statistic can be simulated by simulating new data from the model
without treatment by covariate interactions (model
<code>model,main</code> above).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># loglikehood ratios from 100 datasets generated from null model</span></span>
<span><span class="va">loglikratio_null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>, <span class="kw">function</span><span class="op">(</span><span class="va">seed</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span>  <span class="co"># prog and pred are based on main model without interaction</span></span>
<span>  <span class="va">dat_generate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_y.html">generate_y</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">BM</span>, <span class="va">HX</span>, <span class="va">AGE_cat</span><span class="op">)</span>, trt <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">RX</span>, </span>
<span>                             prog <span class="op">=</span> <span class="st">"0.719 *BM + 0.465 *HX +0.269*AGE_cat"</span>, </span>
<span>                             pred <span class="op">=</span> <span class="st">"0"</span>, b0 <span class="op">=</span> <span class="op">-</span><span class="fl">0.193</span>, b1 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                             type <span class="op">=</span> <span class="st">"survival"</span>, cens_time <span class="op">=</span> <span class="va">cens_time</span>, lambda0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4.376</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">model.full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span>  <span class="va">trt</span> <span class="op">*</span> <span class="op">(</span><span class="va">BM</span> <span class="op">+</span>  <span class="va">HX</span> <span class="op">+</span>  <span class="va">AGE_cat</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat_generate</span><span class="op">)</span></span>
<span>  <span class="va">model.null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">trt</span> <span class="op">+</span> <span class="va">BM</span> <span class="op">+</span> <span class="va">HX</span> <span class="op">+</span> <span class="va">AGE_cat</span>, data <span class="op">=</span> <span class="va">dat_generate</span><span class="op">)</span></span>
<span>  <span class="op">(</span><span class="va">model.full</span><span class="op">$</span><span class="va">loglik</span> <span class="op">-</span> <span class="va">model.null</span><span class="op">$</span><span class="va">loglik</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">## loglikehood ratio for real data using cox model</span></span>
<span><span class="va">model.null.obs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">SURVTIME</span>, <span class="va">CENS</span><span class="op">)</span> <span class="op">~</span> <span class="va">RX</span> <span class="op">+</span> <span class="va">BM</span> <span class="op">+</span> <span class="va">HX</span> <span class="op">+</span> <span class="va">AGE_cat</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">model.full.obs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">SURVTIME</span>, <span class="va">CENS</span><span class="op">)</span> <span class="op">~</span>  <span class="va">RX</span> <span class="op">*</span> <span class="op">(</span><span class="va">BM</span> <span class="op">+</span>  <span class="va">HX</span> <span class="op">+</span>  <span class="va">AGE_cat</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">loglikratio_obs</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">model.full.obs</span><span class="op">$</span><span class="va">loglik</span> <span class="op">-</span> <span class="va">model.null.obs</span><span class="op">$</span><span class="va">loglik</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">*</span><span class="fl">2</span></span>
<span><span class="va">result_anova</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="va">model.null.obs</span>, <span class="va">model.full.obs</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## plot to show the difference </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">loglikratio_null</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">.4</span>, fill <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">stat_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">dchisq</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">result_anova</span><span class="op">$</span><span class="va">Df</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">loglikratio_obs</span>, color <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">'text'</span>, x <span class="op">=</span> <span class="va">loglikratio_obs</span>, y <span class="op">=</span> <span class="fl">0.025</span>, color <span class="op">=</span> <span class="st">'blue'</span>,</span>
<span>           label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'P(X&gt;obs) ='</span>,</span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">loglikratio_null</span> <span class="op">&gt;</span> <span class="va">loglikratio_obs</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">loglikratio_null</span><span class="op">)</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">'text'</span>, x <span class="op">=</span> <span class="va">loglikratio_obs</span>, y <span class="op">=</span> <span class="fl">0.05</span>, color <span class="op">=</span> <span class="st">'red'</span>,</span>
<span>           label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'P(X&gt;obs) ='</span>,</span>
<span>                          <span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html" class="external-link">pchisq</a></span><span class="op">(</span><span class="va">loglikratio_obs</span>, <span class="va">result_anova</span><span class="op">$</span><span class="va">Df</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a02_Examples_Real_Data_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>The blue area is the density of the log-likelihood ratios for the
model with/without interaction under the data generated from main model.
The red line is the density of the chi-squared distribution for the test
of interaction v.s. main model from modeling observed data. It can be
seen that the empirical density matches the theoretical density well.
The black vertical line is the observed log-likelihood ratio for real
data. In response to the generated data test, P-value = 0.002, which is
similar to the chi-square test (P-value = 0.001), indicating the
treatment effect heterogeneity exists(there is interaction effect).</p>
<p>While the procedure here illustrated the approach for a global test
for treatment effect heterogeneity, also other statistics could be
simulated, for example the treatment effect in an identified subgroup
after an algorithmic subgroup search. This simulation approach may be a
valuable tool for assessing the strength of evidence for a subgroup
finding: One could assess for example how likely it is to find a
subgroup with a particular treatment effect in the case of no treatment
by covariate interaction.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Sophie Sun, Bjoern Bornkamp, Jiarui Lu, Ardalan
Mirshani, Kostas Sechidis, Yao Chen, Novartis.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
